local ESP = {}

local playersFolder = workspace:WaitForChild("Players")
local survivorsFolder = playersFolder:WaitForChild("Survivors")
local killersFolder = playersFolder:WaitForChild("Killers")
local ingameMapFolder = workspace:WaitForChild("Map"):WaitForChild("Ingame")

local addedESPs = {}
local connections = {}

-- Creates a BillboardGui label
local function createNameTag(adornee, text, color)
	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESP_NameTag"
	billboard.Adornee = adornee
	billboard.AlwaysOnTop = true
	billboard.Size = UDim2.new(0, 100, 0, 30)
	billboard.StudsOffset = Vector3.new(0, 3, 0)

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = color
	label.TextStrokeTransparency = 0
	label.TextScaled = true
	label.Font = Enum.Font.SourceSansBold
	label.Parent = billboard

	billboard.Parent = adornee

	return billboard
end

-- Creates a highlight for a model or part
local function createHighlight(target, color)
	local highlight = Instance.new("Highlight")
	highlight.Name = "ESP_Highlight"
	highlight.FillColor = color
	highlight.OutlineColor = Color3.new(1, 1, 1)
	highlight.FillTransparency = 0.5
	highlight.OutlineTransparency = 0
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Adornee = target
	highlight.Parent = target

	return highlight
end

-- Adds ESP to models/parts
local function addESP(object, color, customName)
	if addedESPs[object] then return end

	local adornee = object:FindFirstChild("HumanoidRootPart") 
		or (object:IsA("BasePart") and object) 
		or (object:IsA("Model") and object:FindFirstChildWhichIsA("BasePart"))
	if not adornee then return end

	local nameTag = createNameTag(adornee, customName or object.Name, color)
	local highlight = createHighlight(object, color)

	addedESPs[object] = {
		NameTag = nameTag,
		Highlight = highlight,
	}

	-- Track AncestryChanged so ESP cleans up if object removed
	local conn = object.AncestryChanged:Connect(function(_, parent)
		if not parent then
			if addedESPs[object] then
				if addedESPs[object].NameTag then
					addedESPs[object].NameTag:Destroy()
				end
				if addedESPs[object].Highlight then
					addedESPs[object].Highlight:Destroy()
				end
				addedESPs[object] = nil
			end
			conn:Disconnect()
		end
	end)

	table.insert(connections, conn)
end

-- Wrapper for players
local function tryAddPlayerESP(model, color)
	if model:IsA("Model") then
		local root = model:FindFirstChild("HumanoidRootPart")
		if root then
			addESP(model, color)
		else
			coroutine.wrap(function()
				local root = model:WaitForChild("HumanoidRootPart", 5)
				if root then
					addESP(model, color)
				end
			end)()
		end
	end
end

-- Setup for player folders
local function scanFolder(folder, color)
	for _, model in ipairs(folder:GetChildren()) do
		tryAddPlayerESP(model, color)
	end
end

local function watchFolder(folder, color)
	local conn = folder.ChildAdded:Connect(function(model)
		tryAddPlayerESP(model, color)
	end)
	table.insert(connections, conn)
end

-- Setup for environment objects with dynamic watching
local function scanEnvironmentObjects()
	for _, obj in ipairs(ingameMapFolder:GetDescendants()) do
		if obj.Name == "Instances" and obj:IsA("Folder") then
			local gen = obj:FindFirstChild("Generator")
			if gen and gen:IsA("Model") then
				addESP(gen, Color3.fromRGB(0, 150, 255), "GENERATOR")
			end
		elseif obj.Name == "Spike" then
			addESP(obj, Color3.fromRGB(255, 0, 0), "SPIKE")
		elseif obj.Name == "BloxyCola" or obj.Name == "Medkit" then
			addESP(obj, Color3.fromRGB(0, 150, 255), obj.Name)
		elseif obj.Name == "PizzaDeliveryRig" then
			addESP(obj, Color3.fromRGB(255, 165, 0), "PIZZA RIG") -- Orange color
		end
	end
end

local function watchEnvironmentFolder(folder)
	local conn = folder.DescendantAdded:Connect(function(obj)
		if obj.Name == "Instances" and obj:IsA("Folder") then
			local gen = obj:WaitForChild("Generator", 5)
			if gen and gen:IsA("Model") then
				addESP(gen, Color3.fromRGB(0, 150, 255), "GENERATOR")
			end
		elseif obj.Name == "Spike" then
			addESP(obj, Color3.fromRGB(255, 0, 0), "SPIKE")
		elseif obj.Name == "BloxyCola" or obj.Name == "Medkit" then
			addESP(obj, Color3.fromRGB(0, 150, 255), obj.Name)
		elseif obj.Name == "PizzaDeliveryRig" then
			addESP(obj, Color3.fromRGB(255, 165, 0), "PIZZA RIG")
		end
	end)
	table.insert(connections, conn)
end

function ESP.Enable()
	-- Clear existing ESP (if any)
	ESP.Disable()

	scanFolder(survivorsFolder, Color3.fromRGB(0, 255, 0))
	scanFolder(killersFolder, Color3.fromRGB(255, 0, 0))
	watchFolder(survivorsFolder, Color3.fromRGB(0, 255, 0))
	watchFolder(killersFolder, Color3.fromRGB(255, 0, 0))

	scanEnvironmentObjects()
	watchEnvironmentFolder(ingameMapFolder)
end

function ESP.Disable()
	-- Disconnect all event connections
	for _, conn in ipairs(connections) do
		conn:Disconnect()
	end
	connections = {}

	-- Remove all ESP objects
	for object, espData in pairs(addedESPs) do
		if espData.NameTag then
			espData.NameTag:Destroy()
		end
		if espData.Highlight then
			espData.Highlight:Destroy()
		end
		addedESPs[object] = nil
	end
end

return ESP
